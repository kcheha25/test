import numpy as np
import matplotlib.pyplot as plt
from detectron2.utils.visualizer import Visualizer

def visualize_groups_with_overlay(image, outputs, labels):
    # Créer un Visualizer pour afficher les résultats sur l'image
    v = Visualizer(image[:, :, ::-1], metadata=None, scale=1.0)
    
    # Créer un tableau de couleurs pour chaque groupe
    unique_labels = np.unique(labels)
    colors = [tuple(np.random.rand(3)) for _ in unique_labels]  # Couleurs aléatoires pour chaque groupe
    
    # Ajouter les instances avec les couleurs de groupe dans l'overlay
    instances = outputs['instances']
    masks = instances.pred_masks  # Masques sous forme de tenseur

    # Mapper les prédictions aux couleurs selon les groupes
    assigned_colors = []
    for i in range(len(instances)):
        label = labels[i]
        assigned_colors.append(colors[label])  # Assigner la couleur du groupe à chaque prédiction

    # Visualiser les masques avec les couleurs assignées
    v.overlay_instances(masks=masks, assigned_colors=assigned_colors, alpha=0.5)
    
    # Afficher l'image avec l'overlay des groupes
    result_image = v.get_output().get_image()
    plt.figure(figsize=(10, 10))
    plt.imshow(result_image)
    plt.axis('off')
    plt.show()
