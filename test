<label>
  <input type="checkbox" id="multi-mode"> Traiter plusieurs images
</label>

<div id="upload-section">
  <input type="file" id="image-upload" />
  <div id="preview">
    <img id="preview-img" src="" alt="Preview" style="display:none;" />
  </div>
</div>


const multiMode = document.getElementById("multi-mode");
const uploadSection = document.getElementById("upload-section");

multiMode.addEventListener("change", () => {
  uploadSection.innerHTML = ""; // reset

  if (multiMode.checked) {
    // Mode multi-images
    uploadSection.innerHTML = `
      <label>Uploader plusieurs images :</label>
      <input type="file" id="multi-upload" multiple>
    `;
  } else {
    // Mode simple (une image + preview)
    uploadSection.innerHTML = `
      <label>Uploader image :</label>
      <input type="file" id="image-upload">
      <div id="preview">
        <img id="preview-img" src="" alt="Preview" style="display:none;" />
      </div>
    `;

    const uploadInput = document.getElementById("image-upload");
    const previewImg = document.getElementById("preview-img");

    uploadInput.addEventListener("change", function(){
      const file = this.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("image", file);

      fetch("/upload_preview", {method:"POST", body:formData})
        .then(res => res.json())
        .then(data => {
          previewImg.src = data.preview + "?ts=" + new Date().getTime();
          previewImg.style.display = "block";
        })
        .catch(err => console.error(err));
    });
  }
});

<label>
  <input type="checkbox" id="multi-mode"> Mode multi-images
</label>

<div id="upload-section">
  <input type="file" id="image-upload">
  <div id="preview">
    <button id="prev-btn" style="display:none">‚¨ÖÔ∏è</button>
    <img id="preview-img" src="" alt="Preview" style="display:none; max-width:300px;" />
    <button id="next-btn" style="display:none">‚û°Ô∏è</button>
  </div>
</div>

@app.route("/upload_preview", methods=["POST"])
def upload_preview():
    if "multi" in request.form and request.form["multi"] == "true":
        # === MODE MULTI ===
        if "images[]" not in request.files:
            return jsonify({"error": "Aucune image re√ßue"}), 400

        files = request.files.getlist("images[]")
        saved_paths = []

        for file in files:
            orig_name, orig_ext = os.path.splitext(file.filename)
            orig_ext = orig_ext.lower()
            save_path = os.path.join("static", f"{orig_name}{orig_ext}")
            file.save(save_path)

            # conversion en PNG
            img = Image.open(save_path)
            png_path = os.path.join("static", f"{orig_name}.png")
            img.save(png_path, "PNG")
            saved_paths.append(f"/{png_path.replace(os.sep, '/')}")

        return jsonify({"previews": saved_paths})

    else:
        # === MODE SIMPLE ===
        if "image" not in request.files:
            return jsonify({"error": "Aucune image re√ßue"}), 400

        file = request.files["image"]
        orig_name, orig_ext = os.path.splitext(file.filename)
        orig_ext = orig_ext.lower()
        save_path = os.path.join("static", f"uploadedimage{orig_ext}")
        file.save(save_path)

        img = Image.open(save_path)
        png_path = os.path.join("static", "uploadedimage.png")
        img.save(png_path, "PNG")

        return jsonify({"preview": f"/{png_path.replace(os.sep, '/')}"} )

const uploadInput = document.getElementById("image-upload");
const previewImg = document.getElementById("preview-img");
const multiMode = document.getElementById("multi-mode");

let previewImages = [];
let previewIndex = 0;

// Quand fichier(s) choisi(s)
uploadInput.addEventListener("change", function(){
  const formData = new FormData();

  if (multiMode.checked) {
    // === MODE MULTI ===
    for (let f of this.files) formData.append("images[]", f);
    formData.append("multi", "true");
  } else {
    // === MODE SIMPLE ===
    if (!this.files[0]) return;
    formData.append("image", this.files[0]);
    formData.append("multi", "false");
  }

  fetch("/upload_preview", {method:"POST", body:formData})
    .then(res => res.json())
    .then(data => {
      if (multiMode.checked) {
        // Carrousel multi
        previewImages = data.previews;
        previewIndex = 0;
        updatePreview();

        if (previewImages.length > 1) {
          document.getElementById("prev-btn").style.display = "inline-block";
          document.getElementById("next-btn").style.display = "inline-block";
        }
      } else {
        // Simple preview
        previewImg.src = data.preview + "?ts=" + new Date().getTime();
        previewImg.style.display = "block";
        document.getElementById("prev-btn").style.display = "none";
        document.getElementById("next-btn").style.display = "none";
      }
    })
    .catch(err => console.error(err));
});

function updatePreview() {
  if (previewImages.length > 0) {
    previewImg.src = previewImages[previewIndex] + "?ts=" + new Date().getTime();
    previewImg.style.display = "block";
  }
}

document.getElementById("prev-btn").addEventListener("click", () => {
  if (previewImages.length === 0) return;
  previewIndex = (previewIndex - 1 + previewImages.length) % previewImages.length;
  updatePreview();
});

document.getElementById("next-btn").addEventListener("click", () => {
  if (previewImages.length === 0) return;
  previewIndex = (previewIndex + 1) % previewImages.length;
  updatePreview();
});

<label>
  <input type="checkbox" id="multi-mode"> Mode multi-images
</label>

<div id="upload-section"></div>
<div id="preview"></div>
const multiMode = document.getElementById("multi-mode");
const uploadSection = document.getElementById("upload-section");
const preview = document.getElementById("preview");

function renderUploadUI() {
  if (multiMode.checked) {
    // === MODE MULTI ===
    uploadSection.innerHTML = `
      <label>Uploader plusieurs images :</label>
      <input type="file" id="image-upload" multiple>
    `;

    preview.innerHTML = `
      <button id="prev-btn" style="display:none">‚¨ÖÔ∏è</button>
      <img id="preview-img" src="" style="display:none; max-width:300px;" />
      <button id="next-btn" style="display:none">‚û°Ô∏è</button>
    `;
  } else {
    // === MODE SIMPLE ===
    uploadSection.innerHTML = `
      <label>Uploader une image :</label>
      <input type="file" id="image-upload">
    `;

    preview.innerHTML = `
      <img id="preview-img" src="" style="display:none; max-width:300px;" />
    `;
  }
}

// Premier rendu
renderUploadUI();

// R√©agir au changement de checkbox
multiMode.addEventListener("change", () => {
  renderUploadUI();
});


const uploadSection = document.getElementById("upload-section");
const previewImg = document.getElementById("preview-img");
const multiMode = document.getElementById("multi-mode");

let previewImages = [];
let previewIndex = 0;

uploadSection.addEventListener("change", function(e) {
  if (!e.target || e.target.id !== "image-upload") return;

  const files = e.target.files;
  if (!files || files.length === 0) return;

  const formData = new FormData();

  if (multiMode.checked) {
    // === MODE MULTI ===
    for (let f of files) {
      formData.append("images[]", f);
    }
    formData.append("multi", "true");
  } else {
    // === MODE SIMPLE ===
    formData.append("image", files[0]);
    formData.append("multi", "false");
  }

  fetch("/upload_preview", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      if (multiMode.checked) {
        // Carrousel multi
        previewImages = data.previews || [];
        previewIndex = 0;
        updatePreview();

        if (previewImages.length > 1) {
          document.getElementById("prev-btn").style.display = "inline-block";
          document.getElementById("next-btn").style.display = "inline-block";
        }
      } else {
        // Simple preview
        previewImg.src = data.preview + "?ts=" + new Date().getTime();
        previewImg.style.display = "block";
        document.getElementById("prev-btn").style.display = "none";
        document.getElementById("next-btn").style.display = "none";
      }
    })
    .catch(err => console.error(err));
});

function updatePreview() {
  if (previewImages.length > 0) {
    previewImg.src = previewImages[previewIndex] + "?ts=" + new Date().getTime();
    previewImg.style.display = "block";
  }
}

document.getElementById("prev-btn").addEventListener("click", () => {
  if (previewImages.length === 0) return;
  previewIndex = (previewIndex - 1 + previewImages.length) % previewImages.length;
  updatePreview();
});

document.getElementById("next-btn").addEventListener("click", () => {
  if (previewImages.length === 0) return;
  previewIndex = (previewIndex + 1) % previewImages.length;
  updatePreview();
});


@app.route("/upload", methods=["POST"])
def upload():
    if "model" not in request.form:
        return jsonify({"error": "Aucun mod√®le s√©lectionn√©"}), 400

    model_name = request.form["model"]
    multi = request.form.get("multi", "false") == "true"

    results = []
    hists = []

    # üîπ Nettoyer le dossier static (uniquement fichiers racine)
    for filename in os.listdir(STATIC_FOLDER):
        filepath = os.path.join(STATIC_FOLDER, filename)
        if os.path.isfile(filepath) and filename.lower().endswith(('.png', '.jpg', '.jpeg')):
            os.remove(filepath)

    if multi:
        files = request.files.getlist("images[]")
    else:
        files = [request.files["image"]]

    for file in files:
        # Sauvegarder input
        filename = os.path.splitext(file.filename)[0]
        ext = os.path.splitext(file.filename)[1].lower()
        input_path = os.path.join(STATIC_FOLDER, f"{filename}{ext}")
        file.save(input_path)

        # üîπ Faire inf√©rence
        image = cv2.imread(input_path)

        if model_name == "detectron2":
            predictor = load_detectron2()
            outputs = predictor(image)
            v = Visualizer(image[:, :, ::-1], MetadataCatalog.get("coco_2017_train"))
            out = v.draw_instance_predictions(outputs["instances"].to("cpu"))
            result_path = os.path.join(STATIC_FOLDER, f"result_{filename}.png")
            cv2.imwrite(result_path, out.get_image()[:, :, ::-1])

        elif model_name == "mmrotate":
            result_path = os.path.join(STATIC_FOLDER, f"result_{filename}.png")
            cv2.putText(image, "MMRotate d√©tection", (30, 30),
                        cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
            cv2.imwrite(result_path, image)

        elif model_name == "gen3d":
            result_path = os.path.join(STATIC_FOLDER, f"result_{filename}.png")
            cv2.putText(image, "3D Generation", (30, 30),
                        cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 0), 2)
            cv2.imwrite(result_path, image)
        else:
            return jsonify({"error": "Mod√®le inconnu"}), 400

        # üîπ Histogramme
        hist_path = os.path.join(STATIC_FOLDER, f"hist_{filename}.png")
        generate_histogram(input_path, hist_path)

        results.append(f"/{result_path.replace(os.sep, '/')}")
        hists.append(f"/{hist_path.replace(os.sep, '/')}")

    return jsonify({
        "message": "Inf√©rence termin√©e",
        "results": results,
        "hists": hists
    })
fetch("/upload", { method: "POST", body: formData })
  .then(response => response.json())
  .then(data => {
    document.getElementById("ai-result").textContent = "Inf√©rence termin√©e ‚úÖ";
    document.getElementById("ai-instruct").textContent = "R√©sultats affich√©s √† droite.";
    document.getElementById("ai-result-icon").src = "static/assets/validate.png";

    // === Carrousel des r√©sultats ===
    carouselImages = data.results.map(url => url + "?ts=" + new Date().getTime());
    currentIndex = 0;
    carouselImg.src = carouselImages[currentIndex];
    carouselImg.style.display = "block";

    document.querySelector(".prev-btn").style.display = "block";
    document.querySelector(".next-btn").style.display = "block";

    // === Afficher aussi les histogrammes ===
    let histContainer = document.getElementById("hist-container");
    histContainer.innerHTML = "";
    data.hists.forEach(h => {
      let img = document.createElement("img");
      img.src = h + "?ts=" + new Date().getTime();
      img.style.maxWidth = "200px";
      img.style.margin = "5px";
      histContainer.appendChild(img);
    });
  })
  .catch(error => {
    document.getElementById("ai-result").textContent = "Erreur ‚ùå";
    document.getElementById("ai-instruct").textContent = error.message;
    document.getElementById("ai-result-icon").src = "static/assets/pending.png";
  });
let carouselImages = [];
let currentIndex = 0;

function updateCarousel() {
  if (carouselImages.length === 0) return;

  let img = document.getElementById("carousel-img");
  img.src = carouselImages[currentIndex];
}

// === Navigation ===
document.querySelector(".prev-btn").addEventListener("click", () => {
  if (carouselImages.length === 0) return;
  currentIndex = (currentIndex - 1 + carouselImages.length) % carouselImages.length;
  updateCarousel();
});

document.querySelector(".next-btn").addEventListener("click", () => {
  if (carouselImages.length === 0) return;
  currentIndex = (currentIndex + 1) % carouselImages.length;
  updateCarousel();
});

// === Lors de l‚Äôupload ===
fetch("/upload", { method: "POST", body: formData })
  .then(response => response.json())
  .then(data => {
    document.getElementById("ai-result").textContent = "Inf√©rence termin√©e ‚úÖ";
    document.getElementById("ai-instruct").textContent = "R√©sultats affich√©s √† droite.";
    document.getElementById("ai-result-icon").src = "static/assets/validate.png";

    // Fusionner results et hists
    carouselImages = [];
    for (let i = 0; i < data.results.length; i++) {
      carouselImages.push(data.results[i] + "?ts=" + new Date().getTime());
      if (data.hists[i]) {
        carouselImages.push(data.hists[i] + "?ts=" + new Date().getTime());
      }
    }

    currentIndex = 0;
    updateCarousel();

    document.querySelector(".prev-btn").style.display = "block";
    document.querySelector(".next-btn").style.display = "block";
  })
  .catch(error => {
    document.getElementById("ai-result").textContent = "Erreur ‚ùå";
    document.getElementById("ai-instruct").textContent = error.message;
    document.getElementById("ai-result-icon").src = "static/assets/pending.png";
  });
